From 0555cc7792ad5bae0c04146d5fcaafff8c04b0e2 Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Fri, 14 Mar 2014 14:44:38 +0100
Subject: [PATCH] Added netxng on the CMake builds

---
 cmake/modules/RootConfiguration.cmake       |  7 +++++++
 cmake/modules/SearchInstalledSoftware.cmake | 11 +++++++++++
 net/CMakeLists.txt                          |  4 ++++
 net/netxng/CMakeLists.txt                   |  2 +-
 4 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/cmake/modules/RootConfiguration.cmake b/cmake/modules/RootConfiguration.cmake
index da09a1a..c0f5814 100644
--- cmake/modules/RootConfiguration.cmake
+++ cmake/modules/RootConfiguration.cmake
@@ -152,6 +152,13 @@ set(davixlibdir ${DAVIX_LIBRARY_DIR})
 set(davixlib ${DAVIX_LIBRARY})
 set(davixincdir ${DAVIX_INCLUDE_DIR})
 
+set(buildnetxng ${value${netxng}})
+if(netxng)
+  set(useoldnetx no)
+else()
+  set(useoldnetx yes)
+endif()
+
 set(builddcap ${value${dcap}})
 set(dcaplibdir ${DCAP_LIBRARY_DIR})
 set(dcaplib ${DCAP_LIBRARY})
diff --git a/cmake/modules/SearchInstalledSoftware.cmake b/cmake/modules/SearchInstalledSoftware.cmake
index a0d2015..ff9c4e8 100644
--- cmake/modules/SearchInstalledSoftware.cmake
+++ cmake/modules/SearchInstalledSoftware.cmake
@@ -566,6 +566,8 @@ if(xrootd)
       message(STATUS "                  Alternatively, you can also enable the option 'builtin_xrootd' to build XROOTD  internally'")
       message(STATUS "                  For the time being switching OFF 'xrootd' option")
       set(xrootd OFF CACHE BOOL "" FORCE)
+    else()
+      set(xrootd_versionnum ${xrdversnum})  # variable used internally
     endif()
   endif()
 endif()
@@ -578,6 +580,10 @@ if(builtin_xrootd)
     URL http://xrootd.org/download/v${xrootd_version}/xrootd-${xrootd_version}.tar.gz
     INSTALL_DIR ${CMAKE_BINARY_DIR}
     CMAKE_ARGS -DCMAKE_INSTALL_PREFIX:PATH=<INSTALL_DIR>
+               -DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}
+               -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}
+               -DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER}
+               -DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}
   )
   set(XROOTD_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/include/xrootd ${CMAKE_BINARY_DIR}/include/xrootd/private)
   set(XROOTD_LIBRARIES ${CMAKE_BINARY_DIR}/lib/libXrdMain${CMAKE_SHARED_LIBRARY_SUFFIX}
@@ -586,6 +592,11 @@ if(builtin_xrootd)
   set(XROOTD_CFLAGS "-DROOTXRDVERS=${xrootd_versionnum}")
   set(xrootd ON CACHE BOOL "" FORCE)
 endif()
+if(xrootd AND xrootd_versionnum VERSION_GREATER 300030005)
+  set(netxng ON)
+else()
+  set(netxng OFF)
+endif()
 
 #---Check for cling and llvm ----------------------------------------------------------------
 find_library(CMAKE_TINFO_LIBS NAMES tinfo ncurses)
diff --git a/net/CMakeLists.txt b/net/CMakeLists.txt
index 6aab949..0e52b5f 100644
--- net/CMakeLists.txt
+++ net/CMakeLists.txt
@@ -35,3 +35,7 @@ endif()
 if(davix)
    add_subdirectory(davix)
 endif()
+
+if(netxng)
+   add_subdirectory(netxng)
+endif()
\ No newline at end of file
diff --git a/net/netxng/CMakeLists.txt b/net/netxng/CMakeLists.txt
index f9a34a2..554c3b5 100644
--- net/netxng/CMakeLists.txt
+++ net/netxng/CMakeLists.txt
@@ -3,7 +3,7 @@
 # @author Lukasz Janyst <ljanyst@cern.ch>
 ############################################################################
 
-include_directories(${XROOTD_INCLUDE_DIR})
+include_directories(${XROOTD_INCLUDE_DIRS})
 add_definitions(${XROOTD_CFLAGS})
 
 ROOT_GENERATE_DICTIONARY(G__NetxNG *.h MODULE NetxNG LINKDEF LinkDef.h)
-- 
1.7.11.1

From 47d0a80d69e4d6be7e5ae3f06aefa32c523dfc4f Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Fri, 14 Mar 2014 17:59:57 +0100
Subject: [PATCH] Changes associated to builtin_xrootd option

---
 cmake/modules/SearchInstalledSoftware.cmake | 7 +++++--
 net/netxng/CMakeLists.txt                   | 2 +-
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/cmake/modules/SearchInstalledSoftware.cmake b/cmake/modules/SearchInstalledSoftware.cmake
index ff9c4e8..7b1897c 100644
--- cmake/modules/SearchInstalledSoftware.cmake
+++ cmake/modules/SearchInstalledSoftware.cmake
@@ -575,6 +575,8 @@ if(builtin_xrootd)
   set(xrootd_version 3.3.6)
   set(xrootd_versionnum 300030006)
   message(STATUS "Downloading and building XROOTD version ${xrootd_version}") 
+  string(REPLACE "-Wall " "" __cxxflags "${CMAKE_CXX_FLAGS}")                        # Otherwise it produces tones of warnings
+  string(REPLACE "-W " "" __cxxflags "${__cxxflags} -Wno-deprecated-declarations -Wno-duplicate-decl-specifier")
   ExternalProject_Add(
     XROOTD
     URL http://xrootd.org/download/v${xrootd_version}/xrootd-${xrootd_version}.tar.gz
@@ -583,12 +585,13 @@ if(builtin_xrootd)
                -DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}
                -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}
                -DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER}
-               -DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}
+               -DCMAKE_CXX_FLAGS=${__cxxflags}
   )
   set(XROOTD_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/include/xrootd ${CMAKE_BINARY_DIR}/include/xrootd/private)
   set(XROOTD_LIBRARIES ${CMAKE_BINARY_DIR}/lib/libXrdMain${CMAKE_SHARED_LIBRARY_SUFFIX}
                        ${CMAKE_BINARY_DIR}/lib/libXrdUtils${CMAKE_SHARED_LIBRARY_SUFFIX}
-                       ${CMAKE_BINARY_DIR}/lib/libXrdClient${CMAKE_SHARED_LIBRARY_SUFFIX})
+                       ${CMAKE_BINARY_DIR}/lib/libXrdClient${CMAKE_SHARED_LIBRARY_SUFFIX}
+                       ${CMAKE_BINARY_DIR}/lib/libXrdCl${CMAKE_SHARED_LIBRARY_SUFFIX})
   set(XROOTD_CFLAGS "-DROOTXRDVERS=${xrootd_versionnum}")
   set(xrootd ON CACHE BOOL "" FORCE)
 endif()
diff --git a/net/netxng/CMakeLists.txt b/net/netxng/CMakeLists.txt
index 554c3b5..915c0fb 100644
--- net/netxng/CMakeLists.txt
+++ net/netxng/CMakeLists.txt
@@ -8,6 +8,6 @@ add_definitions(${XROOTD_CFLAGS})
 
 ROOT_GENERATE_DICTIONARY(G__NetxNG *.h MODULE NetxNG LINKDEF LinkDef.h)
 
-ROOT_LINKER_LIBRARY(NetxNG *.cxx G__NetxNG.cxx LIBRARIES ${XROOTD_LIBRARIES} DEPENDENCIES RIO Thread)
+ROOT_LINKER_LIBRARY(NetxNG *.cxx G__NetxNG.cxx LIBRARIES ${XROOTD_LIBRARIES} DEPENDENCIES Net RIO Thread)
 
 ROOT_INSTALL_HEADERS()
-- 
1.7.11.1

From 4ee2378c7691b4cfd641c6fb15a582dac32e64da Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Sun, 16 Mar 2014 21:02:04 +0100
Subject: [PATCH] Fix for building  netxng for CMake

---
 cmake/modules/FindXROOTD.cmake | 2 +-
 net/netx/CMakeLists.txt        | 3 +++
 net/netxng/CMakeLists.txt      | 6 ++++++
 3 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/cmake/modules/FindXROOTD.cmake b/cmake/modules/FindXROOTD.cmake
index db703f4..3ee31ab 100644
--- cmake/modules/FindXROOTD.cmake
+++ cmake/modules/FindXROOTD.cmake
@@ -83,7 +83,7 @@ if(XROOTD_FOUND)
       list(APPEND XROOTD_LIBRARIES ${XROOTD_XrdNetUtil_LIBRARY})
     endif ()
   else()
-    foreach(l XrdMain XrdUtils XrdClient)
+    foreach(l XrdMain XrdUtils XrdClient XrdCl)
       find_library(XROOTD_${l}_LIBRARY
          NAMES ${l}
          HINTS ${searchpath}
diff --git a/net/netx/CMakeLists.txt b/net/netx/CMakeLists.txt
index 6d7c5bd..c526638 100644
--- net/netx/CMakeLists.txt
+++ net/netx/CMakeLists.txt
@@ -16,3 +16,6 @@ ROOT_LINKER_LIBRARY(Netx *.cxx G__Netx.cxx LIBRARIES ${XROOTD_LIBRARIES} DEPENDE
 
 ROOT_INSTALL_HEADERS()
 
+if(builtin_xrootd)
+  add_dependencies(Netx XROOTD)
+endif()
diff --git a/net/netxng/CMakeLists.txt b/net/netxng/CMakeLists.txt
index 915c0fb..9eab1cf 100644
--- net/netxng/CMakeLists.txt
+++ net/netxng/CMakeLists.txt
@@ -3,6 +3,8 @@
 # @author Lukasz Janyst <ljanyst@cern.ch>
 ############################################################################
 
+ROOT_USE_PACKAGE(net/net)
+
 include_directories(${XROOTD_INCLUDE_DIRS})
 add_definitions(${XROOTD_CFLAGS})
 
@@ -11,3 +13,7 @@ ROOT_GENERATE_DICTIONARY(G__NetxNG *.h MODULE NetxNG LINKDEF LinkDef.h)
 ROOT_LINKER_LIBRARY(NetxNG *.cxx G__NetxNG.cxx LIBRARIES ${XROOTD_LIBRARIES} DEPENDENCIES Net RIO Thread)
 
 ROOT_INSTALL_HEADERS()
+
+if(builtin_xrootd)
+  add_dependencies(NetxNG XROOTD)
+endif()
-- 
1.7.11.1

From f7fbb919430a46b9cb7bbc945e289cdcf8db3b84 Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Mon, 17 Mar 2014 10:15:39 +0100
Subject: [PATCH] More fixes for building netxng for CMake

---
 cmake/modules/SearchInstalledSoftware.cmake | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/cmake/modules/SearchInstalledSoftware.cmake b/cmake/modules/SearchInstalledSoftware.cmake
index 7b1897c..0c48a18 100644
--- cmake/modules/SearchInstalledSoftware.cmake
+++ cmake/modules/SearchInstalledSoftware.cmake
@@ -587,11 +587,18 @@ if(builtin_xrootd)
                -DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER}
                -DCMAKE_CXX_FLAGS=${__cxxflags}
   )
+  # We cannot call find_package(XROOTD) becuase the package is not yet built. So, we need to emulate what it defines....
+  set(_LIBDIR_DEFAULT "lib")
+  if(CMAKE_SYSTEM_NAME MATCHES "Linux" AND NOT CMAKE_CROSSCOMPILING AND NOT EXISTS "/etc/debian_version")
+    if("${CMAKE_SIZEOF_VOID_P}" EQUAL "8")
+      set(_LIBDIR_DEFAULT "lib64")
+    endif()
+  endif()
   set(XROOTD_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/include/xrootd ${CMAKE_BINARY_DIR}/include/xrootd/private)
-  set(XROOTD_LIBRARIES ${CMAKE_BINARY_DIR}/lib/libXrdMain${CMAKE_SHARED_LIBRARY_SUFFIX}
-                       ${CMAKE_BINARY_DIR}/lib/libXrdUtils${CMAKE_SHARED_LIBRARY_SUFFIX}
-                       ${CMAKE_BINARY_DIR}/lib/libXrdClient${CMAKE_SHARED_LIBRARY_SUFFIX}
-                       ${CMAKE_BINARY_DIR}/lib/libXrdCl${CMAKE_SHARED_LIBRARY_SUFFIX})
+  set(XROOTD_LIBRARIES ${CMAKE_BINARY_DIR}/${_LIBDIR_DEFAULT}/libXrdMain${CMAKE_SHARED_LIBRARY_SUFFIX}
+                       ${CMAKE_BINARY_DIR}/${_LIBDIR_DEFAULT}/libXrdUtils${CMAKE_SHARED_LIBRARY_SUFFIX}
+                       ${CMAKE_BINARY_DIR}/${_LIBDIR_DEFAULT}/libXrdClient${CMAKE_SHARED_LIBRARY_SUFFIX}
+                       ${CMAKE_BINARY_DIR}/${_LIBDIR_DEFAULT}/libXrdCl${CMAKE_SHARED_LIBRARY_SUFFIX})
   set(XROOTD_CFLAGS "-DROOTXRDVERS=${xrootd_versionnum}")
   set(xrootd ON CACHE BOOL "" FORCE)
 endif()
-- 
1.7.11.1

From e4efa2b949e16c284905c417d548152e481f7cad Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Wed, 19 Mar 2014 10:43:22 +0100
Subject: [PATCH] Introduce a fix that was in the patches branch

---
 cmake/modules/FindOracle.cmake | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/cmake/modules/FindOracle.cmake b/cmake/modules/FindOracle.cmake
index 9fb8759..9a13eeb 100644
--- cmake/modules/FindOracle.cmake
+++ cmake/modules/FindOracle.cmake
@@ -75,6 +75,8 @@ IF (NOT DEFINED ORACLE_OCI_VERSION)
       ${ORACLE_HOME}/bin
     )
     IF(SQLPLUS_EXECUTABLE)
+       get_filename_component(bindir ${SQLPLUS_EXECUTABLE} PATH)         # sqlplus executable needs its shared libraries
+       set(ENV{LD_LIBRARY_PATH} ${bindir}/../lib:$ENV{LD_LIBRARY_PATH})
 				 EXECUTE_PROCESS(COMMAND ${SQLPLUS_EXECUTABLE} -version OUTPUT_VARIABLE sqlplus_out)
 				 			 STRING(REGEX MATCH "([0-9.]+)" sqlplus_version ${sqlplus_out})
 							 	      MESSAGE(STATUS "Found sqlplus version: ${sqlplus_version}")
-- 
1.7.11.1
From d89374410b68166e2fff569cbee84f13d5a71c89 Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Wed, 9 Apr 2014 18:12:57 +0200
Subject: [PATCH] Fix for ROOT-6194 - ROOT6 build for LHCb seems to have
 hardcoded dependencies on AFS

---
 cmake/modules/SearchInstalledSoftware.cmake      |  5 ++++-
 interpreter/cling/lib/Interpreter/CMakeLists.txt | 11 ++++++++++-
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/cmake/modules/SearchInstalledSoftware.cmake b/cmake/modules/SearchInstalledSoftware.cmake
index 5e599cb..2bba510 100644
--- cmake/modules/SearchInstalledSoftware.cmake
+++ cmake/modules/SearchInstalledSoftware.cmake
@@ -720,7 +720,10 @@ if(cling)
                         ${CMAKE_BINARY_DIR}/CLING-install/lib/libclingUtils.a 
                         ${LLVM_LIBRARIES})
     #--Additional flags obtained from llvm-config --cxxflags
-    set(CLING_CXXFLAGS "-fvisibility-inlines-hidden -fno-strict-aliasing -Wno-unused-parameter -Wwrite-strings -Wmissing-field-initializers -Wno-long-long -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS")
+    set(CLING_CXXFLAGS "-fvisibility-inlines-hidden -fno-strict-aliasing -Wno-unused-parameter -Wwrite-strings -Wno-long-long -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS")
+    if (CMAKE_COMPILER_IS_GNUCXX)
+      set(CLING_CXXFLAGS "${CLING_CXXFLAGS} -Wno-missing-field-initializers")
+    endif()
     add_dependencies(CLING LLVM)
 endif()
 
diff --git a/interpreter/cling/lib/Interpreter/CMakeLists.txt b/interpreter/cling/lib/Interpreter/CMakeLists.txt
index ce547b7..1b9fdc6 100644
--- interpreter/cling/lib/Interpreter/CMakeLists.txt
+++ interpreter/cling/lib/Interpreter/CMakeLists.txt
@@ -95,8 +95,17 @@ if( git_executable )
   endif( )
 endif( git_executable )
 
+# Remove absolute path from CMAKE_CXX_COMPILER
+get_filename_component(_path ${CMAKE_CXX_COMPILER} PATH)
+get_filename_component(_name ${CMAKE_CXX_COMPILER} NAME)
+if("$ENV{PATH}" MATCHES ${_path})
+  set(CMAKE_CXX_COMPILER_RELATIVE ${_name})
+else()
+  set(CMAKE_CXX_COMPILER_RELATIVE ${CMAKE_CXX_COMPILER})
+endif()
+
 file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/cling-compiledata.h
-  "#define LLVM_CXX \"${CMAKE_CXX_COMPILER} ${CMAKE_CXX_FLAGS_NO_I} ${CMAKE_CXX_FLAGS_${uppercase_CMAKE_BUILD_TYPE}}\"
+  "#define LLVM_CXX \"${CMAKE_CXX_COMPILER_RELATIVE} ${CMAKE_CXX_FLAGS_NO_I} ${CMAKE_CXX_FLAGS_${uppercase_CMAKE_BUILD_TYPE}}\"
 #define CLING_VERSION \"${CLING_VERSION}\"
 "
 )
-- 
1.7.11.1

From 99b08f3885e36d3e96df004d2bcb6a9ed649bfc0 Mon Sep 17 00:00:00 2001
From: Pere Mato <pere.mato@cern.ch>
Date: Wed, 9 Apr 2014 22:37:08 +0200
Subject: [PATCH] Fix for ROOT-6194 and ROOT-6164

---
 cmake/modules/RootConfiguration.cmake | 20 +++++++++++++++-----
 1 file changed, 15 insertions(+), 5 deletions(-)

diff --git a/cmake/modules/RootConfiguration.cmake b/cmake/modules/RootConfiguration.cmake
index c0f5814..2e02de8 100644
--- cmake/modules/RootConfiguration.cmake
+++ cmake/modules/RootConfiguration.cmake
@@ -398,11 +398,7 @@ configure_file(${CMAKE_SOURCE_DIR}/config/RConfigOptions.in include/RConfigOptio
 if(ruby)
   file(APPEND ${CMAKE_BINARY_DIR}/include/RConfigOptions.h "\#define R__RUBY_MAJOR ${RUBY_MAJOR_VERSION}\n\#define R__RUBY_MINOR ${RUBY_MINOR_VERSION}\n")
 endif()
-if(WIN32)
-  configure_file(${CMAKE_SOURCE_DIR}/cmake/scripts/compiledata.win32.in include/compiledata.h)
-else()
-  configure_file(${CMAKE_SOURCE_DIR}/cmake/scripts/compiledata.in include/compiledata.h)
-endif()
+
 configure_file(${CMAKE_SOURCE_DIR}/config/Makefile-comp.in config/Makefile.comp)
 configure_file(${CMAKE_SOURCE_DIR}/config/Makefile.in config/Makefile.config)
 configure_file(${CMAKE_SOURCE_DIR}/config/mimes.unix.in ${CMAKE_BINARY_DIR}/etc/root.mimes)
@@ -472,6 +468,20 @@ if(prefix STREQUAL "$(ROOTSYS)")
   set(etcdir $ROOTSYS/etc)
   set(mandir $ROOTSYS/man/man1)
 endif()
+
+
+#---compiledata.h--------------------------------------------------------------------------------------------
+if(WIN32)
+  set(makecompiledata ${CMAKE_SOURCE_DIR}/build/win/compiledata.sh)
+else()
+  set(makecompiledata ${CMAKE_SOURCE_DIR}/build/unix/compiledata.sh)
+endif()
+
+string(TOUPPER "${CMAKE_BUILD_TYPE}" uppercase_CMAKE_BUILD_TYPE)
+execute_process(COMMAND ${makecompiledata} include/compiledata.h "${cxx}" "" "${CMAKE_CXX_FLAGS_${uppercase_CMAKE_BUILD_TYPE}}"
+	   "${CMAKE_CXX_FLAGS}" "${CMAKE_SHARED_LIBRARY_CREATE_CXX_FLAGS}" "${CMAKE_EXE_FLAGS}" "${LibSuffix}" "${SYSLIBS}"
+	   "${libdir}" "-lCore" "-Rint" "${incdir}" "" "" "${ROOT_ARCHITECTURE}" "" "${explicitlink}" )
+
 configure_file(${CMAKE_SOURCE_DIR}/config/root-config.in ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/root-config @ONLY)
 configure_file(${CMAKE_SOURCE_DIR}/config/memprobe.in ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/memprobe @ONLY)
 configure_file(${CMAKE_SOURCE_DIR}/config/thisroot.sh ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/thisroot.sh @ONLY)
-- 
1.7.11.1


